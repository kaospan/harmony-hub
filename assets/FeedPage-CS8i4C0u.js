import{c as M,j as e,m as w,r as h,a as C,X as q,b as Ae,s as S,u as O,d as z,e as te,A as F,B as k,f as Re,g as oe,h as Fe,P as le,i as $e,k as De,L as Ue,l as He,C as Ke,n as Be}from"./index-BX1-5uJX.js";import{C as Ye}from"./ChordBadge-D8slQnnf.js";import{K as qe,R as Oe}from"./rotate-ccw-DD0Su9mn.js";import{M as ce}from"./music-BxcFe2bf.js";import{O as de,C as ue,a as Qe,T as me,D as he,P as Ve,R as Xe,b as We,c as Ge,Q as Je,B as Ze,u as et}from"./useSpotifyUser-CFeAagmp.js";import{I as tt}from"./input-D92xCCDs.js";import{A as xe,a as fe,b as pe,f as ye}from"./formatDistanceToNow-CBRWQ1EU.js";import{M as Y,S as ge,a as be,b as B,c as J,d as st}from"./scroll-area-l8qt1WvI.js";import{u as H}from"./useQuery-GHdTcwIr.js";import{u as K}from"./useMutation-D6BUY7Ff.js";import{u as at}from"./index-B5wY23Ui.js";import{S as it,u as nt,P as rt}from"./useFollowing-4xm-lB-S.js";import{L as ie}from"./label-C4H-16-b.js";import{U as Z,B as ee}from"./BottomNav-DdksZANf.js";import{C as ot,S as lt}from"./index-C8qaemdP.js";import{P as we}from"./play-DrkYy18X.js";import{H as ct}from"./heart-DyKYkRn4.js";import{s as dt}from"./seedTracks-CpIFGQdB.js";import{C as ut}from"./circle-alert-X8gfNAie.js";import"./index-CEPZ7l09.js";import"./providers-TqTXgJ0o.js";import"./index-BiV5K_eQ.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=M("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ht=M("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xt=M("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=M("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=M("Minimize2",[["polyline",{points:"4 14 10 14 10 20",key:"11kfnr"}],["polyline",{points:"20 10 14 10 14 4",key:"rlmsce"}],["line",{x1:"14",x2:"21",y1:"10",y2:"3",key:"o5lafz"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=M("PictureInPicture2",[["path",{d:"M21 9V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v10c0 1.1.9 2 2 2h4",key:"daa4of"}],["rect",{width:"10",height:"7",x:"12",y:"13",rx:"2",key:"1nb8gs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=M("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=M("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=M("Twitter",[["path",{d:"M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z",key:"pff0z6"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wt=M("Waves",[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=M("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]);function vt({progression:t,detectedKey:s,detectedMode:a,cadenceType:i,confidenceScore:n,matchReason:o}){return e.jsxs(w.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(qe,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[s||"Unknown"," ",a&&a!=="unknown"?a:""]})]}),i&&i!=="none"&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(Oe,{className:"w-3 h-3"}),e.jsx("span",{className:"capitalize",children:i})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ce,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.map((l,c)=>e.jsx(w.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:c*.05},children:e.jsx(Ye,{chord:l,size:"md"})},c))})]}),o&&e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed pt-1 border-t border-border/50",children:o}),n!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted rounded-full overflow-hidden",children:e.jsx(w.div,{initial:{width:0},animate:{width:`${n*100}%`},transition:{delay:.3,duration:.5},className:"h-full bg-gradient-to-r from-primary to-accent rounded-full"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(n*100),"%"]})]})]})}const se=Xe,ae=We,Nt=Ve,je=h.forwardRef(({className:t,...s},a)=>e.jsx(de,{className:C("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:a}));je.displayName=de.displayName;const kt=Ae("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Q=h.forwardRef(({side:t="right",className:s,children:a,...i},n)=>e.jsxs(Nt,{children:[e.jsx(je,{}),e.jsxs(ue,{ref:n,className:C(kt({side:t}),s),...i,children:[a,e.jsxs(Qe,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-secondary hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(q,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Q.displayName=ue.displayName;const V=({className:t,...s})=>e.jsx("div",{className:C("flex flex-col space-y-2 text-center sm:text-left",t),...s});V.displayName="SheetHeader";const X=h.forwardRef(({className:t,...s},a)=>e.jsx(me,{ref:a,className:C("text-lg font-semibold text-foreground",t),...s}));X.displayName=me.displayName;const _t=h.forwardRef(({className:t,...s},a)=>e.jsx(he,{ref:a,className:C("text-sm text-muted-foreground",t),...s}));_t.displayName=he.displayName;function Ct(t){return H({queryKey:["track-comments",t],queryFn:async()=>{const{data:s,error:a}=await S.from("track_comments").select(`
          *,
          profiles:user_id (
            display_name,
            avatar_url
          )
        `).eq("track_id",t).order("created_at",{ascending:!0});if(a)throw a;return(s||[]).map(i=>{var n,o;return{...i,user_display_name:((n=i.profiles)==null?void 0:n.display_name)||"Anonymous",user_avatar_url:(o=i.profiles)==null?void 0:o.avatar_url}})},enabled:!!t})}function St(){const t=O(),{user:s}=z();return K({mutationFn:async({trackId:a,content:i,parentId:n})=>{if(!s)throw new Error("Must be logged in to comment");const{data:o,error:l}=await S.from("track_comments").insert({track_id:a,user_id:s.id,content:i,parent_id:n||null}).select().single();if(l)throw l;return o},onSuccess:(a,i)=>{t.invalidateQueries({queryKey:["track-comments",i.trackId]})}})}function Tt(){const t=O();return K({mutationFn:async({commentId:s,trackId:a})=>{const{error:i}=await S.from("track_comments").delete().eq("id",s);if(i)throw i},onSuccess:(s,a)=>{t.invalidateQueries({queryKey:["track-comments",a.trackId]})}})}function Mt(t){return H({queryKey:["comment-count",t],queryFn:async()=>{const{count:s,error:a}=await S.from("track_comments").select("*",{count:"exact",head:!0}).eq("track_id",t);if(a)throw a;return s||0},enabled:!!t})}function Pt({trackId:t,trackTitle:s}){const[a,i]=h.useState(!1),[n,o]=h.useState(""),{user:l}=z(),c=te(),{data:u=[],isLoading:f}=Ct(t),{data:p=0}=Mt(t),r=St(),d=Tt(),m=async x=>{if(x.preventDefault(),!!n.trim()){if(!l){c("/auth");return}try{await r.mutateAsync({trackId:t,content:n.trim()}),o("")}catch(j){console.error("Failed to add comment:",j)}}},b=async x=>{try{await d.mutateAsync({commentId:x,trackId:t})}catch(j){console.error("Failed to delete comment:",j)}};return e.jsxs(se,{open:a,onOpenChange:i,children:[e.jsx(ae,{asChild:!0,children:e.jsxs(w.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(Y,{className:"w-6 h-6"}),p>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-primary text-primary-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:p>99?"99+":p})]}),e.jsx("span",{className:"text-xs font-medium",children:"Comments"})]})}),e.jsxs(Q,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(V,{className:"pb-4 border-b border-border",children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5 text-primary"}),'Comments on "',s,'"']})}),e.jsxs("div",{className:"flex flex-col h-[calc(80vh-8rem)]",children:[e.jsx(ge,{className:"flex-1 py-4",children:f?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(x=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-24 bg-muted rounded"}),e.jsx("div",{className:"h-4 w-full bg-muted rounded"})]})]},x))}):u.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Y,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No comments yet"}),e.jsx("p",{className:"text-sm",children:"Be the first to share your thoughts!"})]}):e.jsx(F,{mode:"popLayout",children:u.map((x,j)=>{var v;return e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.9},transition:{delay:j*.05},className:"flex gap-3 mb-4 group",children:[e.jsxs(xe,{className:"w-10 h-10",children:[e.jsx(fe,{src:x.user_avatar_url}),e.jsx(pe,{className:"bg-primary/20 text-primary",children:((v=x.user_display_name)==null?void 0:v.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:x.user_display_name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:ye(new Date(x.created_at),{addSuffix:!0})})]}),e.jsx("p",{className:"text-sm text-foreground/90 mt-1 break-words",children:x.content})]}),(l==null?void 0:l.id)===x.user_id&&e.jsx(k,{variant:"ghost",size:"icon",className:"opacity-0 group-hover:opacity-100 transition-opacity h-8 w-8 text-destructive",onClick:()=>b(x.id),children:e.jsx(gt,{className:"w-4 h-4"})})]},x.id)})})}),e.jsxs("form",{onSubmit:m,className:"flex gap-2 pt-4 border-t border-border",children:[e.jsx(tt,{value:n,onChange:x=>o(x.target.value),placeholder:l?"Add a comment...":"Sign in to comment",className:"flex-1",disabled:!l||r.isPending}),e.jsx(k,{type:"submit",size:"icon",disabled:!n.trim()||r.isPending,className:"shrink-0",children:e.jsx(be,{className:"w-4 h-4"})})]})]})]})]})}var W="Switch",[zt,Ns]=Re(W),[Et,It]=zt(W),ve=h.forwardRef((t,s)=>{const{__scopeSwitch:a,name:i,checked:n,defaultChecked:o,required:l,disabled:c,value:u="on",onCheckedChange:f,form:p,...r}=t,[d,m]=h.useState(null),b=oe(s,T=>m(T)),x=h.useRef(!1),j=d?p||!!d.closest("form"):!0,[v,P]=Fe({prop:n,defaultProp:o??!1,onChange:f,caller:W});return e.jsxs(Et,{scope:a,checked:v,disabled:c,children:[e.jsx(le.button,{type:"button",role:"switch","aria-checked":v,"aria-required":l,"data-state":Ce(v),"data-disabled":c?"":void 0,disabled:c,value:u,...r,ref:b,onClick:$e(t.onClick,T=>{P(_=>!_),j&&(x.current=T.isPropagationStopped(),x.current||T.stopPropagation())})}),j&&e.jsx(_e,{control:d,bubbles:!x.current,name:i,value:u,checked:v,required:l,disabled:c,form:p,style:{transform:"translateX(-100%)"}})]})});ve.displayName=W;var Ne="SwitchThumb",ke=h.forwardRef((t,s)=>{const{__scopeSwitch:a,...i}=t,n=It(Ne,a);return e.jsx(le.span,{"data-state":Ce(n.checked),"data-disabled":n.disabled?"":void 0,...i,ref:s})});ke.displayName=Ne;var Lt="SwitchBubbleInput",_e=h.forwardRef(({__scopeSwitch:t,control:s,checked:a,bubbles:i=!0,...n},o)=>{const l=h.useRef(null),c=oe(l,o),u=at(a),f=De(s);return h.useEffect(()=>{const p=l.current;if(!p)return;const r=window.HTMLInputElement.prototype,m=Object.getOwnPropertyDescriptor(r,"checked").set;if(u!==a&&m){const b=new Event("click",{bubbles:i});m.call(p,a),p.dispatchEvent(b)}},[u,a,i]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:a,...n,tabIndex:-1,ref:c,style:{...n.style,...f,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});_e.displayName=Lt;function Ce(t){return t?"checked":"unchecked"}var Se=ve,At=ke;const Te=h.forwardRef(({className:t,...s},a)=>e.jsx(Se,{className:C("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",t),...s,ref:a,children:e.jsx(At,{className:C("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));Te.displayName=Se.displayName;function re(t,s,a,i){const o=(a-t)*Math.PI/180,l=(i-s)*Math.PI/180,c=Math.sin(o/2)*Math.sin(o/2)+Math.cos(t*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function Me(){const{user:t}=z();return H({queryKey:["user-location",t==null?void 0:t.id],queryFn:async()=>{if(!t)return null;const{data:s,error:a}=await S.from("user_locations").select("*").eq("user_id",t.id).maybeSingle();if(a)throw a;return s},enabled:!!t})}function Rt(){const t=O(),{user:s}=z();return K({mutationFn:async({latitude:a,longitude:i,sharingEnabled:n=!0,radiusKm:o=50})=>{if(!s)throw new Error("Must be logged in");const{data:l,error:c}=await S.from("user_locations").upsert({user_id:s.id,latitude:a,longitude:i,sharing_enabled:n,radius_km:o}).select().single();if(c)throw c;return l},onSuccess:()=>{t.invalidateQueries({queryKey:["user-location"]}),t.invalidateQueries({queryKey:["nearby-listeners"]})}})}function Ft(){const t=O(),{user:s}=z();return K({mutationFn:async()=>{if(!s)throw new Error("Must be logged in");const{error:a}=await S.from("user_locations").update({sharing_enabled:!1}).eq("user_id",s.id);if(a)throw a},onSuccess:()=>{t.invalidateQueries({queryKey:["user-location"]})}})}function $t(t,s){const{user:a}=z(),{data:i}=Me();return H({queryKey:["nearby-listeners",t,s,i==null?void 0:i.latitude,i==null?void 0:i.longitude],queryFn:async()=>{if(!a||!(i!=null&&i.sharing_enabled))return[];const{data:n,error:o}=await S.from("user_locations").select("user_id, latitude_fuzzy, longitude_fuzzy").eq("sharing_enabled",!0).neq("user_id",a.id);if(o)throw o;const l=(n||[]).filter(r=>re(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))<=i.radius_km).map(r=>({user_id:r.user_id,distance_km:re(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))}));if(l.length===0)return[];const{data:c,error:u}=await S.from("profiles").select("id, display_name, avatar_url").in("id",l.map(r=>r.user_id));if(u)throw u;let f=[];if(t||s){let r=S.from("nearby_activity").select("*").in("user_id",l.map(m=>m.user_id)).order("listened_at",{ascending:!1});if(t&&(r=r.eq("track_id",t)),s){const m=s.replace(/[%_]/g,"\\$&");r=r.ilike("artist",`%${m}%`)}const{data:d}=await r;f=d||[]}return l.map(({user_id:r,distance_km:d})=>{const m=(c||[]).find(x=>x.id===r),b=f.find(x=>x.user_id===r);return{user_id:r,display_name:(m==null?void 0:m.display_name)||"Anonymous",avatar_url:m==null?void 0:m.avatar_url,distance_km:Math.round(d*10)/10,last_track:b==null?void 0:b.track_id,last_artist:b==null?void 0:b.artist,listened_at:b==null?void 0:b.listened_at}}).filter(r=>!t&&!s?!0:f.some(d=>d.user_id===r.user_id)).sort((r,d)=>r.distance_km-d.distance_km)},enabled:!!a&&!!(i!=null&&i.sharing_enabled)})}function Dt(){const{user:t}=z();return K({mutationFn:async({trackId:s,artist:a})=>{if(!t)return;const{error:i}=await S.from("nearby_activity").insert({user_id:t.id,track_id:s,artist:a||null});if(i)throw i}})}function Ut({trackId:t,artist:s,trackTitle:a}){const[i,n]=h.useState(!1),[o,l]=h.useState(!1),[c,u]=h.useState(50),[f,p]=h.useState(!1),{user:r}=z(),d=te(),{data:m,isLoading:b}=Me(),{data:x=[],isLoading:j}=$t(t,s),v=Rt(),P=Ft();h.useEffect(()=>{m!=null&&m.radius_km&&u(m.radius_km)},[m==null?void 0:m.radius_km]);const T=async()=>{if(!r){d("/auth");return}p(!0);try{const g=await new Promise((y,N)=>{navigator.geolocation.getCurrentPosition(y,N,{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})});await v.mutateAsync({latitude:g.coords.latitude,longitude:g.coords.longitude,sharingEnabled:!0,radiusKm:c})}catch(g){console.error("Location error:",g)}finally{p(!1)}},_=async g=>{const y=g[0];u(y),m&&await v.mutateAsync({latitude:m.latitude,longitude:m.longitude,sharingEnabled:!0,radiusKm:y})},I=async g=>{g&&!m?await T():g?m&&await v.mutateAsync({latitude:m.latitude,longitude:m.longitude,sharingEnabled:g,radiusKm:c}):await P.mutateAsync()},R=(m==null?void 0:m.sharing_enabled)??!1;return e.jsxs(se,{open:i,onOpenChange:n,children:[e.jsx(ae,{asChild:!0,children:e.jsxs(w.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(Z,{className:"w-6 h-6"}),R&&x.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-accent text-accent-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:x.length})]}),e.jsx("span",{className:"text-xs font-medium",children:"Nearby"})]})}),e.jsxs(Q,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(V,{className:"pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5 text-accent"}),a?`Listeners of "${a}"`:"Nearby Music Lovers"]}),e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>l(!o),className:"h-8 w-8",children:e.jsx(yt,{className:"w-4 h-4"})})]})}),e.jsx(F,{children:o&&e.jsx(w.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden border-b border-border",children:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4 text-primary"}),e.jsx(ie,{htmlFor:"location-sharing",children:"Share my location"})]}),e.jsx(Te,{id:"location-sharing",checked:R,onCheckedChange:I,disabled:v.isPending||P.isPending})]}),R&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ie,{children:"Discovery radius"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[c," km"]})]}),e.jsx(it,{value:[c],onValueChange:_,min:5,max:100,step:5,className:"w-full"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your location is only visible to others who also share theirs."})]})})}),e.jsx("div",{className:"flex flex-col h-[calc(80vh-10rem)]",children:e.jsx(ge,{className:"flex-1 py-4",children:r?R?j||b?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(g=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted rounded"}),e.jsx("div",{className:"h-3 w-24 bg-muted rounded"})]})]},g))}):x.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Ge,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No listeners nearby yet"}),e.jsx("p",{className:"text-sm",children:"Check back later or expand your radius"})]}):e.jsx(F,{mode:"popLayout",children:x.map((g,y)=>{var N;return e.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:y*.05},className:"flex gap-3 mb-4 p-3 rounded-xl glass hover:bg-muted/30 transition-colors",children:[e.jsxs(xe,{className:"w-12 h-12",children:[e.jsx(fe,{src:g.avatar_url}),e.jsx(pe,{className:"bg-accent/20 text-accent",children:((N=g.display_name)==null?void 0:N.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:g.display_name}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(B,{className:"w-3 h-3"}),g.distance_km," km"]})]}),g.last_artist&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Recently listened to ",g.last_artist]}),g.listened_at&&e.jsx("p",{className:"text-xs text-muted-foreground",children:ye(new Date(g.listened_at),{addSuffix:!0})})]})]},g.user_id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Enable location sharing"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Discover people nearby who love the same music"}),e.jsxs(k,{onClick:T,disabled:f,className:"gap-2",children:[f?e.jsx(Ue,{className:"w-4 h-4 animate-spin"}):e.jsx(B,{className:"w-4 h-4"}),"Enable Location"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Z,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Sign in to discover nearby listeners"}),e.jsx(k,{onClick:()=>d("/auth"),children:"Sign In"})]})})})]})]})}function Ht({track:t,onShare:s}){const[a,i]=h.useState(!1),[n,o]=h.useState(!1),{toast:l}=He(),c=`${window.location.origin}/track/${t.id}`,u=`Check out "${t.title}" by ${t.artist} on HarmonyFeed! ðŸŽµ`,f=async()=>{try{await navigator.clipboard.writeText(c),o(!0),l({title:"Link copied!"}),setTimeout(()=>o(!1),2e3),s==null||s()}catch{l({title:"Failed to copy",variant:"destructive"})}},p=async()=>{if(navigator.share)try{await navigator.share({title:t.title,text:u,url:c}),s==null||s(),i(!1)}catch{}},r=[{name:"Copy Link",icon:n?ot:mt,onClick:f,className:n?"text-green-500":""},{name:"Twitter/X",icon:bt,onClick:()=>{window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(u)}&url=${encodeURIComponent(c)}`,"_blank"),s==null||s()}},{name:"WhatsApp",icon:Y,onClick:()=>{window.open(`https://wa.me/?text=${encodeURIComponent(u+" "+c)}`,"_blank"),s==null||s()}},{name:"Telegram",icon:be,onClick:()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(c)}&text=${encodeURIComponent(u)}`,"_blank"),s==null||s()}}];return e.jsxs(se,{open:a,onOpenChange:i,children:[e.jsx(ae,{asChild:!0,children:e.jsxs(k,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(J,{className:"w-4 h-4"}),"Share"]})}),e.jsxs(Q,{side:"bottom",className:"rounded-t-3xl",children:[e.jsx(V,{className:"pb-4",children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-primary"}),'Share "',t.title,'"']})}),e.jsxs("div",{className:"space-y-4 pb-8",children:[e.jsxs("div",{className:"flex gap-3 p-3 rounded-xl glass",children:[t.cover_url?e.jsx("img",{src:t.cover_url,alt:"",className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(ht,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium truncate",children:t.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t.artist})]})]}),typeof navigator<"u"&&"share"in navigator&&e.jsxs(k,{onClick:p,className:"w-full gap-2",variant:"default",children:[e.jsx(J,{className:"w-4 h-4"}),"Share"]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:r.map(d=>e.jsxs(w.button,{whileTap:{scale:.95},onClick:d.onClick,className:"flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsx("div",{className:`p-3 rounded-full bg-muted ${d.className||""}`,children:e.jsx(d.icon,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:d.name})]},d.name))})]})]})]})}function Pe({videoId:t,title:s,startTime:a,endTime:i,onClose:n,onPipModeChange:o,className:l}){const[c,u]=h.useState(!1),[f,p]=h.useState(!1),r=h.useRef(null),m=(()=>{const j=new URLSearchParams({autoplay:"1",rel:"0",modestbranding:"1",playsinline:"1",enablejsapi:"1"});return a!==void 0&&j.append("start",Math.floor(a).toString()),i!==void 0&&j.append("end",Math.floor(i).toString()),`https://www.youtube.com/embed/${t}?${j.toString()}`})(),b=()=>{const j=!f;p(j),o==null||o(j)},x=()=>{p(!1),o==null||o(!1),n==null||n()};return f?e.jsxs(w.div,{initial:{opacity:0,scale:.8,y:50},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.8,y:50},drag:!0,dragConstraints:{left:-300,right:0,top:-400,bottom:0},className:"fixed bottom-24 right-4 z-50 w-[280px] aspect-video rounded-xl overflow-hidden shadow-2xl bg-black border border-border",style:{touchAction:"none"},children:[e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-1.5 bg-gradient-to-b from-black/80 to-transparent",children:[e.jsx("span",{className:"text-white text-xs font-medium truncate px-1 max-w-[150px]",children:s}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-6 w-6 text-white hover:bg-white/20",onClick:b,title:"Exit mini player",children:e.jsx(ne,{className:"w-3 h-3"})}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-6 w-6 text-white hover:bg-white/20",onClick:x,children:e.jsx(q,{className:"w-3 h-3"})})]})]}),e.jsx("iframe",{ref:r,src:m,title:s||"YouTube video player",className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0,referrerPolicy:"strict-origin-when-cross-origin"})]}):e.jsxs(w.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:C("relative rounded-xl overflow-hidden bg-black shadow-2xl",c?"fixed inset-4 z-50":"w-full aspect-video",l),children:[e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-2 bg-gradient-to-b from-black/60 to-transparent",children:[s&&e.jsx("span",{className:"text-white text-sm font-medium truncate px-2",children:s}),e.jsxs("div",{className:"flex items-center gap-1 ml-auto",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-8 w-8 text-white hover:bg-white/20",onClick:b,title:"Mini player (keeps playing while you browse)",children:e.jsx(pt,{className:"w-4 h-4"})}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-8 w-8 text-white hover:bg-white/20",onClick:()=>u(!c),children:c?e.jsx(ft,{className:"w-4 h-4"}):e.jsx(ne,{className:"w-4 h-4"})}),n&&e.jsx(k,{variant:"ghost",size:"icon",className:"h-8 w-8 text-white hover:bg-white/20",onClick:x,children:e.jsx(q,{className:"w-4 h-4"})})]})]}),e.jsx("iframe",{ref:r,src:m,title:s||"YouTube video player",className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0,referrerPolicy:"strict-origin-when-cross-origin"}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/80 -z-10",onClick:()=>u(!1)})]})}const Kt={intro:"from-blue-500/20 to-blue-600/10",verse:"from-purple-500/20 to-purple-600/10","pre-chorus":"from-indigo-500/20 to-indigo-600/10",chorus:"from-pink-500/20 to-pink-600/10",bridge:"from-orange-500/20 to-orange-600/10",breakdown:"from-red-500/20 to-red-600/10",drop:"from-yellow-500/20 to-yellow-600/10",outro:"from-teal-500/20 to-teal-600/10"},Bt={intro:"ðŸŽ¬",verse:"ðŸ“","pre-chorus":"ðŸŽµ",chorus:"ðŸŽ¤",bridge:"ðŸŒ‰",breakdown:"ðŸ’¥",drop:"âš¡",outro:"ðŸŽ­"};function Yt({sections:t,youtubeId:s,title:a,className:i}){const[n,o]=h.useState(null);if(!t||t.length===0)return null;const l=u=>{o(n===u?null:u)},c=u=>{const f=Math.floor(u/60),p=Math.floor(u%60);return`${f}:${p.toString().padStart(2,"0")}`};return e.jsxs("div",{className:C("space-y-3",i),children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(st,{className:"w-4 h-4"}),e.jsx("span",{children:"Song Structure"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:t.map((u,f)=>e.jsxs(w.button,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>l(f),className:C("w-full p-3 rounded-xl transition-all","bg-gradient-to-br",Kt[u.type],"border border-white/10","hover:border-white/20",n===f&&"ring-2 ring-primary","flex items-center justify-between gap-2"),children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"text-lg flex-shrink-0",children:Bt[u.type]}),e.jsxs("div",{className:"flex flex-col items-start min-w-0",children:[e.jsx("span",{className:"text-xs font-semibold text-foreground truncate",children:u.label||u.type.charAt(0).toUpperCase()+u.type.slice(1)}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[c(u.start_time),u.end_time&&` - ${c(u.end_time)}`]})]})]}),e.jsx(we,{className:"w-4 h-4 flex-shrink-0"})]},f))}),e.jsx(F,{children:n!==null&&e.jsx(w.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx("div",{className:"rounded-lg overflow-hidden",children:e.jsx(Pe,{videoId:s,title:`${a} - ${t[n].label||t[n].type}`,startTime:t[n].start_time,endTime:t[n].end_time,onClose:()=>o(null)})})})})]})]})}function qt({track:t,isActive:s,onInteraction:a,interactions:i=new Set,onPipModeActivate:n,isPipActive:o=!1}){const{user:l}=z(),[c,u]=h.useState(!1),[f,p]=h.useState(!1),r=h.useRef(null),d=h.useRef(null),m=Dt(),b=nt();h.useEffect(()=>{!s&&c&&j()},[s]),h.useEffect(()=>()=>{r.current&&r.current.pause()},[]);const x=h.useCallback(async()=>{if(r.current&&t.preview_url)try{await r.current.play(),u(!0),d.current=Date.now(),m.mutate({trackId:t.id,artist:t.artist})}catch(_){console.error("Playback failed:",_)}},[t.preview_url,t.id,t.artist,m]),j=h.useCallback(()=>{if(r.current&&(r.current.pause(),u(!1),d.current&&l)){const _=Date.now()-d.current;b.mutate({trackId:t.id,durationMs:_,source:"feed"}),d.current=null}},[l,t.id,b]),v=()=>{c?j():x()},P=()=>{if(u(!1),d.current&&l){const _=Date.now()-d.current;b.mutate({trackId:t.id,durationMs:_,source:"feed"}),d.current=null}},T=()=>{a("share")};return e.jsxs(w.div,{initial:{opacity:0},animate:{opacity:s?1:.5},className:"relative w-full h-full flex flex-col",children:[t.preview_url&&e.jsx("audio",{ref:r,src:t.preview_url,preload:"none",onEnded:P}),e.jsx("div",{className:"absolute inset-0 z-0",children:f&&t.youtube_id&&!o?e.jsxs("div",{className:"w-full h-full",children:[e.jsx("iframe",{src:`https://www.youtube.com/embed/${t.youtube_id}?autoplay=1&mute=0&controls=1&rel=0&modestbranding=1&playsinline=1&enablejsapi=1`,title:`${t.title} - ${t.artist}`,className:"w-full h-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0,referrerPolicy:"strict-origin-when-cross-origin"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/60 to-transparent pointer-events-none"})]}):t.cover_url?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t.cover_url,alt:"",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/80 to-background/40"})]}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w.h2,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},className:"text-2xl font-bold text-foreground line-clamp-2",children:t.title}),e.jsx(w.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.05},className:"text-lg text-muted-foreground",children:t.artist})]}),t.sections&&t.sections.length>0&&t.youtube_id&&!f&&e.jsx(w.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.08},children:e.jsx(Yt,{sections:t.sections,youtubeId:t.youtube_id,title:`${t.title} - ${t.artist}`})}),e.jsxs(w.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"flex items-center gap-3",children:[t.preview_url&&e.jsxs(k,{variant:"outline",size:"lg",onClick:v,className:"gap-2 glass border-white/20 hover:bg-white/10",children:[c?e.jsx(rt,{className:"w-5 h-5"}):e.jsx(we,{className:"w-5 h-5"}),c?"Pause":"Preview"]}),t.youtube_id&&e.jsxs(k,{variant:f?"default":"outline",size:"lg",onClick:()=>p(!f),className:C("gap-2",f?"bg-red-600 hover:bg-red-700 text-white":"glass border-white/20 hover:bg-white/10"),children:[e.jsx(jt,{className:"w-5 h-5"}),f?"Hide":"Watch"]}),e.jsx(Je,{track:{spotifyId:t.spotify_id||void 0,youtubeId:t.youtube_id||void 0,urlSpotifyWeb:t.url_spotify_web||void 0,urlSpotifyApp:t.url_spotify_app||void 0,urlYoutube:t.url_youtube||void 0},size:"md"})]}),t.progression_roman&&t.progression_roman.length>0&&e.jsx(w.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15},children:e.jsx(vt,{progression:t.progression_roman,detectedKey:t.detected_key,detectedMode:t.detected_mode,cadenceType:t.cadence_type,confidenceScore:t.confidence_score,matchReason:"Same viâ€“IVâ€“Iâ€“V loop with similar energy"})}),e.jsxs(w.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"flex items-center justify-between pt-4",children:[e.jsx(U,{icon:q,label:"Skip",isActive:i.has("skip"),onClick:()=>a("skip"),variant:"muted"}),e.jsx(U,{icon:lt,label:"Harmonic",isActive:i.has("more_harmonic"),onClick:()=>a("more_harmonic"),variant:"primary"}),e.jsx(U,{icon:ct,label:"Like",isActive:i.has("like"),onClick:()=>a("like"),variant:"accent"}),e.jsx(U,{icon:wt,label:"Vibe",isActive:i.has("more_vibe"),onClick:()=>a("more_vibe"),variant:"primary"}),e.jsx(U,{icon:Ze,label:"Save",isActive:i.has("save"),onClick:()=>a("save"),variant:"muted"})]}),e.jsxs(w.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"flex items-center justify-center gap-4",children:[e.jsx(Pt,{trackId:t.id,trackTitle:t.title}),e.jsx(Ut,{trackId:t.id,artist:t.artist,trackTitle:t.title}),e.jsx(Ht,{track:t,onShare:T})]})]})]})}function U({icon:t,label:s,isActive:a,onClick:i,variant:n}){return e.jsxs(w.button,{whileTap:{scale:.9},onClick:i,className:C("flex flex-col items-center gap-1 p-3 rounded-xl transition-all",a&&n==="accent"&&"text-accent glow-accent",a&&n==="primary"&&"text-primary glow-primary",a&&n==="muted"&&"text-foreground",!a&&"text-muted-foreground hover:text-foreground"),children:[e.jsx("div",{className:C("p-3 rounded-full transition-all",a&&n==="accent"&&"bg-accent/20",a&&n==="primary"&&"bg-primary/20",a&&n==="muted"&&"bg-muted",!a&&"bg-muted/50 hover:bg-muted"),children:e.jsx(t,{className:C("w-6 h-6",a&&n==="accent"&&"fill-current")})}),e.jsx("span",{className:"text-xs font-medium",children:s})]})}function Ot(){return e.jsxs("div",{className:"relative w-full h-full flex flex-col",children:[e.jsx("div",{className:"absolute inset-0 z-0",children:e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background animate-shimmer"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},className:"h-8 w-3/4 bg-muted/50 rounded-lg animate-shimmer"}),e.jsx(w.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.05},className:"h-6 w-1/2 bg-muted/50 rounded-lg animate-shimmer"})]}),e.jsx("div",{className:"h-12 w-36 bg-muted/50 rounded-xl animate-shimmer"}),e.jsxs("div",{className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsx("div",{className:"h-4 w-24 bg-muted/50 rounded animate-shimmer"}),e.jsx("div",{className:"flex gap-2",children:[1,2,3,4].map(t=>e.jsx("div",{className:"h-8 w-12 bg-muted/50 rounded-lg animate-shimmer",style:{animationDelay:`${t*100}ms`}},t))})]}),e.jsx("div",{className:"flex items-center justify-between pt-4",children:[1,2,3,4,5].map(t=>e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("div",{className:"w-12 h-12 bg-muted/50 rounded-full animate-shimmer"}),e.jsx("div",{className:"w-10 h-3 bg-muted/50 rounded animate-shimmer"})]},t))})]})]})}function Qt(t){return{...t,sections:Array.isArray(t.sections)?t.sections:void 0,detected_mode:t.detected_mode||void 0}}async function Vt(t){try{let s=S.from("tracks").select("*");if(t.id&&(s=s.eq("id",t.id)),t.spotifyId&&(s=s.eq("spotify_id",t.spotifyId)),t.youtubeId&&(s=s.eq("youtube_id",t.youtubeId)),t.search){const n=t.search.replace(/[%_,().*\\]/g,"");s=s.or(`title.ilike.%${n}%,artist.ilike.%${n}%`)}t.limit&&(s=s.limit(t.limit)),t.offset&&(s=s.range(t.offset,t.offset+(t.limit||20)-1));const{data:a,error:i}=await s;return i?(console.warn("Database fetch failed:",i.message),null):a?a.map(n=>Qt(n)):null}catch(s){return console.warn("Database fetch error:",s),null}}function Xt(t){let s=[...dt];if(t.id&&(s=s.filter(n=>n.id===t.id)),t.spotifyId&&(s=s.filter(n=>n.spotify_id===t.spotifyId)),t.youtubeId&&(s=s.filter(n=>n.youtube_id===t.youtubeId)),t.search){const n=t.search.toLowerCase();s=s.filter(o=>{var l,c;return o.title.toLowerCase().includes(n)||((l=o.artist)==null?void 0:l.toLowerCase().includes(n))||((c=o.album)==null?void 0:c.toLowerCase().includes(n))})}const a=t.offset||0,i=t.limit||20;return s.slice(a,a+i)}async function Wt(t={}){const s=await Vt(t);if(s&&s.length>0)return{tracks:s,source:"database",total:s.length};const a=Xt(t);return{tracks:a,source:"seed",total:a.length}}async function Gt(t=20){return Wt({limit:t})}const Jt={profile:["profile"],userProviders:["user-providers"],following:["following"],followers:["followers"],followingFeed:["following-feed"],TRACKS:"tracks",FEED:"feed",trackComments:t=>["track-comments",t],trackConnections:t=>["track-connections",t],playHistory:["play-history"],playStats:["play-stats"],userLocation:["user-location"],nearbyListeners:(t,s)=>["nearby-listeners",t,s],unifiedSearch:t=>["unified-search",t]};function Zt(t=20){return H({queryKey:[Jt.FEED,t],queryFn:()=>Gt(t),staleTime:5*60*1e3})}function ks(){const{user:t,loading:s}=z(),a=te(),{data:i,isLoading:n,error:o}=Zt(50),{data:l,isLoading:c}=et(20),u=(i==null?void 0:i.tracks)??[],f=(l==null?void 0:l.tracks)??[],p=(()=>{if(f.length>0){const y=new Set(f.map(E=>E.spotify_id)),N=u.filter(E=>!y.has(E.spotify_id));return[...f,...N]}return u})(),r=f.length>0?"spotify":i==null?void 0:i.source,[d,m]=h.useState(0),[b,x]=h.useState(new Map),j=h.useRef(null),[v,P]=h.useState(null),T=y=>{var E;if(!t){a("/auth");return}const N=(E=p[d])==null?void 0:E.id;N&&(x(L=>{const $=new Map(L),A=new Set(L.get(N)||[]);return A.has(y)?A.delete(y):A.add(y),$.set(N,A),$}),y==="skip"&&d<p.length-1&&m(L=>L+1))},_=h.useCallback(()=>{d<p.length-1&&m(y=>y+1)},[d,p.length]),I=h.useCallback(()=>{d>0&&m(y=>y-1)},[d]);h.useEffect(()=>{const y=N=>{N.target instanceof HTMLInputElement||N.target instanceof HTMLTextAreaElement||(N.key==="ArrowDown"||N.key==="j"?_():(N.key==="ArrowUp"||N.key==="k")&&I())};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[_,I]),h.useEffect(()=>{const y=j.current;if(!y)return;let N=0,E=0,L=0;const $=D=>{N=D.touches[0].clientY,E=D.touches[0].clientX,L=Date.now()},A=D=>{const ze=D.changedTouches[0].clientY,Ee=D.changedTouches[0].clientX,G=N-ze,Ie=Math.abs(E-Ee),Le=Date.now()-L;Math.abs(G)>50&&Math.abs(G)>Ie&&Le<500&&(G>0?_():I())};return y.addEventListener("touchstart",$,{passive:!0}),y.addEventListener("touchend",A,{passive:!0}),()=>{y.removeEventListener("touchstart",$),y.removeEventListener("touchend",A)}},[_,I]);const R=(y,N)=>{P({videoId:y,title:N})};if(s||n)return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Ot,{}),e.jsx(ee,{})]});if(o)return e.jsxs("div",{className:"min-h-screen bg-background flex items-center justify-center",children:[e.jsxs("div",{className:"text-center p-6",children:[e.jsx(ut,{className:"w-12 h-12 text-destructive mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Failed to load tracks"}),e.jsx("p",{className:"text-muted-foreground",children:"Please try again later"})]}),e.jsx(ee,{})]});const g=p[d];return e.jsxs("div",{className:"min-h-screen bg-background flex flex-col touch-pan-y",ref:j,children:[e.jsx("header",{className:"fixed top-0 left-0 right-0 z-40 glass-strong safe-top",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 max-w-lg mx-auto",children:[e.jsx("h1",{className:"text-lg font-bold gradient-text",children:"HarmonyFeed"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[d+1," / ",p.length,r==="spotify"&&e.jsx("span",{className:"ml-1 text-[#1DB954] flex items-center gap-0.5",title:"Your Spotify history",children:e.jsx(ce,{className:"w-3 h-3"})}),r==="seed"&&e.jsx("span",{className:"ml-1 text-amber-500",title:"Using demo data",children:"â€¢"})]}),!t&&e.jsxs(k,{variant:"ghost",size:"sm",onClick:()=>a("/auth"),className:"gap-1.5",children:[e.jsx(xt,{className:"w-4 h-4"}),"Sign in"]})]})]})}),e.jsxs("div",{className:"hidden md:flex fixed left-4 top-1/2 -translate-y-1/2 z-30 flex-col gap-2",children:[e.jsx(k,{variant:"outline",size:"icon",className:"glass",onClick:I,disabled:d===0,children:e.jsx(Ke,{className:"w-5 h-5"})}),e.jsx(k,{variant:"outline",size:"icon",className:"glass",onClick:_,disabled:d===p.length-1,children:e.jsx(Be,{className:"w-5 h-5"})})]}),e.jsx("main",{className:"flex-1 pt-16 pb-24",children:e.jsx("div",{className:"h-[calc(100vh-10rem)] max-w-lg mx-auto",children:e.jsx(F,{mode:"wait",children:g&&e.jsx(w.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},transition:{duration:.3},className:"h-full",children:e.jsx(qt,{track:g,isActive:!0,onInteraction:T,interactions:b.get(g.id)||new Set,onPipModeActivate:R,isPipActive:(v==null?void 0:v.videoId)===g.youtube_id})},g.id)})})}),e.jsx(F,{children:v&&e.jsx(Pe,{videoId:v.videoId,title:v.title,onClose:()=>P(null),onPipModeChange:y=>{y||P(null)}},`pip-${v.videoId}`)}),e.jsx(ee,{})]})}export{ks as default};
