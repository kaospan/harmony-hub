import{c as N,a2 as E,e as P,d as R,r as p,j as e,G as T,B as S,s as O}from"./index-BX1-5uJX.js";import{g as A,c as k}from"./useSpotifyConnect-DYJZA0Kv.js";import{C as I}from"./circle-alert-X8gfNAie.js";import"./useMutation-D6BUY7Ff.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=N("CircleCheck",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),z="https://accounts.spotify.com/api/token";function B(){const[t]=E(),a=P(),{user:i}=R(),[n,u]=p.useState("loading"),[w,b]=p.useState("");return p.useEffect(()=>{async function j(){var h;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(t.entries()));const o=t.get("code"),s=t.get("state"),l=t.get("error"),m=t.get("error_description");if(l)throw console.error("[Spotify Callback] Spotify error:",l,m),new Error(m||`Spotify authorization failed: ${l}`);if(!o||!s)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const r=A();if(console.log("[Spotify Callback] Stored state:",((h=r==null?void 0:r.state)==null?void 0:h.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(s==null?void 0:s.substring(0,8))+"..."),!r||r.state!==s)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!i)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const C="b1d936a5b2bd4cb199d3ede9a4fa2449",g="http://localhost:8080/spotify-callback";console.log("[Spotify Callback] Using redirect URI:",g);const d=await fetch(z,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:g,client_id:C,code_verifier:r.codeVerifier})});if(!d.ok){const f=await d.json();throw console.error("[Spotify Callback] Token exchange failed:",f),new Error(f.error_description||`Token exchange failed: ${f.error}`)}console.log("[Spotify Callback] Token exchange successful");const c=await d.json();console.log("[Spotify Callback] Fetching Spotify profile...");const x=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${c.access_token}`}});if(!x.ok)throw new Error("Failed to fetch Spotify profile");const v=await x.json(),_=new Date(Date.now()+c.expires_in*1e3).toISOString(),{error:y}=await O.from("user_providers").upsert({user_id:i.id,provider:"spotify",provider_user_id:v.id,access_token:c.access_token,refresh_token:c.refresh_token,expires_at:_,connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(y)throw console.error("Failed to store Spotify connection:",y),new Error("Failed to save Spotify connection");k(),u("success"),setTimeout(()=>{a("/profile",{replace:!0})},2e3)}catch(o){console.error("Spotify callback error:",o),b(o instanceof Error?o.message:"Unknown error"),u("error"),k()}}j()},[t,i,a]),e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[n==="loading"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{size:"lg"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),n==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:e.jsx(U,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."})]}),n==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:e.jsx(I,{className:"w-8 h-8 text-destructive"})}),e.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),e.jsx("p",{className:"text-muted-foreground",children:w}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(S,{variant:"outline",onClick:()=>a("/profile"),children:"Go to Profile"}),e.jsx(S,{onClick:()=>a("/profile"),children:"Try Again"})]})]})]})})}export{B as default};
